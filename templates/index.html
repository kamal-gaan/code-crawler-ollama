<!DOCTYPE html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <title>Local Code Crawler & Agent</title>
    <style>
      body {
        font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto,
          sans-serif;
        line-height: 1.6;
        color: #333;
        max-width: 900px;
        margin: 20px auto;
        padding: 0 20px;
        background-color: #f9f9f9;
      }
      h1,
      h2,
      h3 {
        color: #111;
      }
      .container {
        background-color: #fff;
        padding: 25px;
        border-radius: 8px;
        box-shadow: 0 2px 10px rgba(0, 0, 0, 0.1);
        margin-bottom: 25px;
      }
      input[type="text"] {
        width: calc(100% - 22px);
        padding: 10px;
        border: 1px solid #ddd;
        border-radius: 4px;
        margin-bottom: 10px;
      }
      button {
        background-color: #007bff;
        color: white;
        padding: 10px 15px;
        border: none;
        border-radius: 4px;
        cursor: pointer;
        font-size: 16px;
        transition: background-color 0.2s;
      }
      button:hover {
        background-color: #0056b3;
      }
      button:disabled {
        background-color: #cccccc;
        cursor: not-allowed;
      }
      .status,
      .result {
        margin-top: 15px;
        padding: 15px;
        border-radius: 4px;
        word-wrap: break-word;
      }
      .status-success {
        background-color: #e6ffed;
        border: 1px solid #b7e1c7;
      }
      .status-error {
        background-color: #ffebe6;
        border: 1px solid #e1b7b7;
      }
      .loader {
        border: 4px solid #f3f3f3;
        border-top: 4px solid #3498db;
        border-radius: 50%;
        width: 20px;
        height: 20px;
        animation: spin 2s linear infinite;
        display: none;
        margin: 10px 0;
      }
      @keyframes spin {
        0% {
          transform: rotate(0deg);
        }
        100% {
          transform: rotate(360deg);
        }
      }
      pre {
        background-color: #2d2d2d;
        color: #f8f8f2;
        padding: 15px;
        border-radius: 5px;
        white-space: pre-wrap;
        word-wrap: break-word;
      }
    </style>
  </head>
  <body>
    <h1>Local Code Crawler & Agent</h1>
    <p>Index, ask questions, and improve your code using a local LLM agent.</p>

    <div class="container">
      <h2>1. Index Your Codebase</h2>
      <label for="path">Absolute path to your code directory:</label>
      <input
        type="text"
        id="path"
        placeholder="C:\Users\YourUser\Documents\my-project"
      />
      <button id="indexBtn">Index Code</button>
      <div class="loader" id="indexLoader"></div>
      <div id="status" class="status"></div>
    </div>

    <div class="container">
      <h2>2. Ask a Question</h2>
      <label for="question">Ask something about your code:</label>
      <input
        type="text"
        id="question"
        placeholder="e.g., What is the purpose of the RAGService class?"
      />
      <button id="askBtn">Ask Question</button>
      <div class="loader" id="askLoader"></div>
      <div id="askResult" class="result"></div>
    </div>

    <div class="container">
      <h2>3. Improve Code (Agent Task)</h2>
      <p>
        <strong>Task: Add docstrings to a file.</strong><br /><em
          >Note: This requires a codebase to be indexed first.</em
        >
      </p>
      <label for="filePath"
        >File path relative to indexed directory (e.g., `src/main.py`):</label
      >
      <input type="text" id="filePath" placeholder="app.py" />
      <button id="improveBtn">Run Improvement Agent</button>
      <div class="loader" id="improveLoader"></div>
      <div id="improveResult" class="result"></div>
    </div>

    <script>
      // --- Element Selectors ---
      const indexBtn = document.getElementById("indexBtn");
      const askBtn = document.getElementById("askBtn");
      const improveBtn = document.getElementById("improveBtn");
      const pathInput = document.getElementById("path");
      const questionInput = document.getElementById("question");
      const filePathInput = document.getElementById("filePath");
      const statusDiv = document.getElementById("status");
      const askResultDiv = document.getElementById("askResult");
      const improveResultDiv = document.getElementById("improveResult");
      const indexLoader = document.getElementById("indexLoader");
      const askLoader = document.getElementById("askLoader");
      const improveLoader = document.getElementById("improveLoader");

      // --- State Management ---
      let currentCollectionName = "";

      // --- Indexing Logic ---
      indexBtn.addEventListener("click", async () => {
        const path = pathInput.value.trim();
        if (!path) {
          return alert("Please provide a path.");
        }
        const collectionName =
          path.split("\\").pop().split("/").pop() || "default-collection";

        statusDiv.innerHTML = "";
        indexLoader.style.display = "block";
        indexBtn.disabled = true;

        try {
          const response = await fetch("/api/collections", {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              path: path,
              collection_name: collectionName,
            }),
          });
          const data = await response.json();
          statusDiv.classList.remove("status-error", "status-success");
          if (response.ok) {
            currentCollectionName = collectionName;
            statusDiv.textContent =
              data.message +
              ` Collection '${currentCollectionName}' is now active.`;
            statusDiv.classList.add("status-success");
          } else {
            currentCollectionName = "";
            statusDiv.textContent = "Error: " + data.error;
            statusDiv.classList.add("status-error");
          }
        } catch (error) {
          currentCollectionName = "";
          statusDiv.classList.add("status-error");
          statusDiv.textContent = "An unexpected error occurred: " + error;
        } finally {
          indexLoader.style.display = "none";
          indexBtn.disabled = false;
        }
      });

      // --- Q&A Logic ---
      askBtn.addEventListener("click", async () => {
        if (!currentCollectionName) {
          return alert("Please index a codebase first.");
        }
        const question = questionInput.value.trim();
        if (!question) {
          return alert("Please ask a question.");
        }

        askResultDiv.innerHTML = "";
        askLoader.style.display = "block";
        askBtn.disabled = true;

        try {
          const askUrl = `/api/collections/${currentCollectionName}/ask`;
          const response = await fetch(askUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({ question: question }),
          });
          const data = await response.json();
          if (response.ok) {
            askResultDiv.innerHTML = `<pre>${data.answer}</pre>`;
          } else {
            askResultDiv.innerHTML = `<p class="status status-error">Error: ${data.error}</p>`;
          }
        } catch (error) {
          askResultDiv.innerHTML = `<p class="status status-error">An unexpected error occurred: ${error}</p>`;
        } finally {
          askLoader.style.display = "none";
          askBtn.disabled = false;
        }
      });

      // --- Agent Improvement Logic ---
      improveBtn.addEventListener("click", async () => {
        if (!currentCollectionName) {
          return alert("Please index a codebase first.");
        }
        const relativeFilePath = filePathInput.value.trim();
        if (!relativeFilePath) {
          return alert("Please provide a file path to improve.");
        }
        const fullFilePath =
          `${pathInput.value.trim()}/${relativeFilePath}`.replace(/\\/g, "/");

        improveResultDiv.innerHTML = "";
        improveLoader.style.display = "block";
        improveBtn.disabled = true;

        try {
          const improveUrl = `/api/collections/${currentCollectionName}/improve`;
          const response = await fetch(improveUrl, {
            method: "POST",
            headers: { "Content-Type": "application/json" },
            body: JSON.stringify({
              file_path: fullFilePath,
              task: "add docstrings",
            }),
          });
          const data = await response.json();
          if (response.ok) {
            improveResultDiv.innerHTML = `<h3>Modified Code:</h3><pre>${data.modified_code}</pre>`;
          } else {
            improveResultDiv.innerHTML = `<p class="status status-error">Error: ${data.error}</p>`;
          }
        } catch (error) {
          improveResultDiv.innerHTML = `<p class="status status-error">An unexpected error occurred: ${error}</p>`;
        } finally {
          improveLoader.style.display = "none";
          improveBtn.disabled = false;
        }
      });
    </script>
  </body>
</html>
